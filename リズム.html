<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Tap Logger</title>
  <style>
    html, body {
      margin: 0; height: 100%;
      background: #0b0b12; color: #fff;
      font-family: system-ui, -apple-system, sans-serif;
      overscroll-behavior: none;
      touch-action: none;
    }
    #app {
      height: 100%;
      display: grid;
      grid-template-rows: auto 1fr auto auto;
      gap: 10px;
      padding: 12px 16px; /* ç«¯ã‚¹ãƒ¯ã‚¤ãƒ—å¯¾ç­–ï¼šå†…å´ã«å¯„ã›ã‚‹ */
      box-sizing: border-box;
    }
    #topbar {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      font-size: 14px;
    }
    input, button {
      font-size: 14px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: #fff;
    }
    button { cursor: pointer; }
    button.primary { background: #7c3aed; border-color: #7c3aed; }
    button.danger { background: #ef4444; border-color: #ef4444; }

    #stage {
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: radial-gradient(1200px 700px at 50% 25%, rgba(124,58,237,.20), rgba(0,0,0,0)) , #080810;
      position: relative;
      overflow: hidden;
      display: grid;
      place-items: center;
      user-select: none;
      -webkit-user-select: none;
      touch-action: none;
    }
    #tapTarget {
      width: min(44vh, 320px);
      height: min(44vh, 320px);
      border-radius: 999px;
      display: grid;
      place-items: center;
      background: rgba(255,255,255,.06);
      border: 2px solid rgba(255,255,255,.18);
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      touch-action: none;
    }
    #tapTarget:active { transform: scale(0.985); background: rgba(124,58,237,.20); }
    #tapTarget span { font-size: 54px; }
    #hud {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      font-size: 14px;
      opacity: .95;
    }
    #status {
      font-weight: 800;
      font-size: 16px;
      min-width: 120px;
      text-align: right;
    }
    #logBox {
      max-height: 180px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      white-space: pre;
    }
  </style>
</head>
<body>
<div id="app">
  <div id="topbar">
    <input id="songName" type="text" placeholder="æ¥½æ›²åï¼ˆè‡ªåˆ†ã§å…¥åŠ›ï¼‰" style="min-width:220px;" />
    <input id="audioFile" type="file" accept="audio/*" />
    <span id="durationLabel">æ›²: æœªèª­ã¿è¾¼ã¿</span>
    <button id="initAudio" class="primary">éŸ³å£°åˆæœŸåŒ–ï¼ˆã‚¿ãƒƒãƒ—å¿…é ˆï¼‰</button>
    <button id="playBtn">å†ç”Ÿã—ã¦åéŒ²</button>
    <button id="stopBtn" class="danger">åœæ­¢</button>
    <button id="exportBtn">ãƒ­ã‚°æ›¸ãå‡ºã—(JSON)</button>
  </div>

  <div id="stage">
    <div id="tapTarget"><span>ğŸ¥</span></div>
  </div>

  <div id="hud">
    <div>
      <div>ã‚¿ãƒƒãƒ—æ•°: <span id="tapCount">0</span></div>
      <div>ã‚ªãƒ•ã‚»ãƒƒãƒˆ(ms): <input id="offsetMs" type="number" value="0" style="width:90px; padding:8px 10px;" /></div>
    </div>
    <div id="status">READY</div>
  </div>

  <div id="logBox"></div>
</div>

<script>
(() => {
  const audioFile = document.getElementById('audioFile');
  const songNameInput = document.getElementById('songName');
  const durationLabel = document.getElementById('durationLabel');

  const initAudioBtn = document.getElementById('initAudio');
  const playBtn = document.getElementById('playBtn');
  const stopBtn = document.getElementById('stopBtn');
  const exportBtn = document.getElementById('exportBtn');

  const tapTarget = document.getElementById('tapTarget');
  const tapCountEl = document.getElementById('tapCount');
  const offsetMsInput = document.getElementById('offsetMs');
  const statusEl = document.getElementById('status');
  const logEl = document.getElementById('logBox');

  /** @type {AudioContext|null} */
  let audioCtx = null;
  /** @type {AudioBuffer|null} */
  let audioBuffer = null;
  /** @type {AudioBufferSourceNode|null} */
  let sourceNode = null;

  let isPlaying = false;
  let startCtxTime = 0;   // audioCtx.currentTime at start
  let startSongTime = 0;  // (pause/resumeæ‹¡å¼µç”¨) ä»Šã¯å¸¸ã«0

  // ãƒ­ã‚°ï¼ˆã‚ã¨ã§è§£æç”¨ã«ååˆ†ãªæƒ…å ±ã‚’å…¥ã‚Œã‚‹ï¼‰
  // { idx, tSong, tCtx, clientMs, x, y, areaW, areaH }
  const taps = [];

  function log(line) {
    logEl.textContent += line + "\n";
    logEl.scrollTop = logEl.scrollHeight;
  }
  function setStatus(s) { statusEl.textContent = s; }

  function fmtDuration(sec) {
    const m = Math.floor(sec / 60);
    const s = Math.floor(sec % 60);
    return `${m}åˆ†${String(s).padStart(2,'0')}ç§’`;
  }

  function songTimeNow() {
    if (!isPlaying || !audioCtx) return 0;
    const t = (audioCtx.currentTime - startCtxTime) + startSongTime;
    const offsetSec = (Number(offsetMsInput.value || 0) / 1000);
    return t + offsetSec;
  }

  // iOSã‚ºãƒ¼ãƒ /ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æŠ‘æ­¢ï¼ˆå®Œå…¨ã§ã¯ãªã„ãŒã ã„ã¶åŠ¹ãï¼‰
  document.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });
  document.addEventListener('dblclick', (e) => e.preventDefault(), { passive: false });
  let lastTouchEnd = 0;
  document.addEventListener('touchend', (e) => {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) e.preventDefault();
    lastTouchEnd = now;
  }, { passive: false });

  initAudioBtn.addEventListener('click', async () => {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: 'interactive' });
    }
    if (audioCtx.state !== 'running') await audioCtx.resume();
    setStatus('AUDIO OK');
  });

  audioFile.addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: 'interactive' });

    const ab = await file.arrayBuffer();
    audioBuffer = await audioCtx.decodeAudioData(ab.slice(0));
    durationLabel.textContent = `æ›²: ${fmtDuration(audioBuffer.duration)}`;
    setStatus('LOADED');
    log(`[LOAD] name="${file.name}" duration=${audioBuffer.duration.toFixed(3)}s`);
  });

  playBtn.addEventListener('click', async () => {
    if (!audioCtx || !audioBuffer) { setStatus('æ›²ã‚’èª­ã¿è¾¼ã‚“ã§'); return; }
    if (audioCtx.state !== 'running') await audioCtx.resume();
    if (isPlaying) return;

    // åéŒ²é–‹å§‹ï¼šãƒ­ã‚°ã‚¯ãƒªã‚¢
    taps.length = 0;
    tapCountEl.textContent = '0';

    const songName = songNameInput.value.trim();
    if (!songName) { setStatus('æ¥½æ›²åã‚’å…¥åŠ›ã—ã¦'); return; }

    sourceNode = audioCtx.createBufferSource();
    sourceNode.buffer = audioBuffer;
    sourceNode.connect(audioCtx.destination);

    startSongTime = 0;
    startCtxTime = audioCtx.currentTime;
    isPlaying = true;

    sourceNode.start(0, startSongTime);
    setStatus('REC');

    log(`[START] songName="${songName}" offsetMs=${Number(offsetMsInput.value||0)}`);

    sourceNode.onended = () => {
      isPlaying = false;
      sourceNode = null;
      setStatus('END');
      log(`[END] taps=${taps.length}`);
    };
  });

  stopBtn.addEventListener('click', () => {
    if (!isPlaying) return;
    try { sourceNode?.stop(); } catch {}
    isPlaying = false;
    sourceNode = null;
    setStatus('STOP');
    log(`[STOP] taps=${taps.length}`);
  });

  function recordTap(ev) {
    if (!isPlaying || !audioCtx) return;

    // ã‚¿ãƒƒãƒ—ä½ç½®ï¼ˆ1ç‚¹ã§ã‚‚ã€Œã©ã“ã‚’å©ã„ãŸã‹ã€ã‚’æ®‹ã™è¦ä»¶ï¼‰
    const rect = tapTarget.getBoundingClientRect();
    const x = (ev.clientX - rect.left);
    const y = (ev.clientY - rect.top);

    const tSong = songTimeNow();
    const tCtx = audioCtx.currentTime;
    const clientMs = performance.now();

    const idx = taps.length;
    taps.push({
      idx,
      tSong: Number(tSong.toFixed(6)),
      tCtx: Number(tCtx.toFixed(6)),
      clientMs: Number(clientMs.toFixed(3)),
      x: Number(x.toFixed(2)),
      y: Number(y.toFixed(2)),
      areaW: Number(rect.width.toFixed(2)),
      areaH: Number(rect.height.toFixed(2))
    });

    tapCountEl.textContent = String(taps.length);

    log(`[TAP] #${idx} tSong=${tSong.toFixed(3)} x=${x.toFixed(1)} y=${y.toFixed(1)}`);
  }

  // pointerdownã§å³åå¿œã€‚passive:falseã§preventDefault
  tapTarget.addEventListener('pointerdown', (ev) => {
    ev.preventDefault();
    recordTap(ev);
  }, { passive: false });

  exportBtn.addEventListener('click', () => {
    const songName = songNameInput.value.trim();
    if (!songName) { setStatus('æ¥½æ›²åã‚’å…¥åŠ›ã—ã¦'); return; }
    if (!audioBuffer) { setStatus('æ›²ã‚’èª­ã¿è¾¼ã‚“ã§'); return; }

    const data = {
      version: 1,
      song: {
        name: songName,
        durationSec: Number(audioBuffer.duration.toFixed(6)),
      },
      device: {
        userAgent: navigator.userAgent,
        devicePixelRatio: window.devicePixelRatio || 1
      },
      settings: {
        offsetMs: Number(offsetMsInput.value || 0),
      },
      taps: taps
    };

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${songName}_taplog.json`;
    a.click();
    URL.revokeObjectURL(a.href);

    setStatus('EXPORTED');
    log(`[EXPORT] ${a.download} (taps=${taps.length})`);
  });

  setStatus('READY');
  log('1) æ¥½æ›²åå…¥åŠ› 2) æ›²é¸æŠ 3) éŸ³å£°åˆæœŸåŒ– 4) å†ç”Ÿã—ã¦ğŸ¥ã‚’ã‚¿ãƒƒãƒ— 5) JSONæ›¸ãå‡ºã—');
})();
</script>
</body>
</html>
