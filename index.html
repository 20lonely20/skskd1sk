<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Canvas Editor Snapshot Log</title>

<style>
body{
  margin:0;
  display:flex;
  height:100vh;
  background:#222;
  color:#fff;
  font-family:sans-serif;
}
#canvasWrap{
  flex:1;
  display:flex;
  justify-content:center;
  align-items:center;
  background:#000;
}
canvas{ background:#555; }

#panel{
  width:420px;
  padding:10px;
  background:#333;
  overflow:auto;
}

h3{
  margin:8px 0 4px;
  font-size:14px;
}

.layer-item{
  display:flex;
  align-items:center;
  gap:4px;
  padding:4px;
  background:#444;
  margin-bottom:4px;
  cursor:pointer;
}
.layer-item.active{ background:#666; }
.layer-item span{
  flex:1;
  font-size:11px;
}
.layer-item button{ width:24px; }

label{
  display:block;
  font-size:12px;
  margin-top:6px;
}
input{ width:100%; }

#logBox{
  background:#111;
  font-size:11px;
  padding:6px;
  margin-top:6px;
  white-space:pre-wrap;
  max-height:300px;
  overflow:auto;
}
.log-new{
  color:#ff8;
  border-bottom:1px solid #333;
  padding-bottom:6px;
  margin-bottom:8px;
}
</style>
</head>

<body>

<div id="canvasWrap">
  <canvas id="canvas"></canvas>
</div>

<div id="panel">
  <label>
    画像追加
    <input type="file" id="imgInput">
  </label>

  <h3>レイヤー一覧（①が最前面）</h3>
  <div id="layerList"></div>

  <h3>選択レイヤー編集</h3>
  <label>X <input type="number" id="xI"></label>
  <label>Y <input type="number" id="yI"></label>
  <label>Scale <input type="number" step="0.01" id="sI"></label>
  <label>Rotate <input type="number" id="rI"></label>
  <label>Float（0〜10） <input type="number" min="0" max="10" id="fI"></label>
  <label>Speed（1〜10） <input type="number" min="1" max="10" id="spI"></label>

  <button id="snapshotBtn">この画面を丸ごと保存（ログ）</button>

  <h3>ログ履歴（完全スナップショット）</h3>
  <div id="logBox"></div>
</div>

<script>
/* ===== 基本 ===== */
const BASE_W = 1280;
const BASE_H = 720;
const FLOAT_PX = 4;
const SPEED_UNIT = 0.8;

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

/* ===== resize ===== */
function resize(){
  const wrap = document.getElementById("canvasWrap");
  const r = wrap.getBoundingClientRect();
  const scale = Math.min(r.width/BASE_W, r.height/BASE_H);
  canvas.width = BASE_W * scale;
  canvas.height = BASE_H * scale;
  ctx.setTransform(scale,0,0,scale,0,0);
}
window.addEventListener("resize", resize);
resize();

/* ===== データ ===== */
let layers = []; // index0 = 最前面
let current = null;

/* ===== UI参照 ===== */
const listEl = document.getElementById("layerList");
const xI = document.getElementById("xI");
const yI = document.getElementById("yI");
const sI = document.getElementById("sI");
const rI = document.getElementById("rI");
const fI = document.getElementById("fI");
const spI = document.getElementById("spI");
const logBox = document.getElementById("logBox");

/* ===== 画像追加 ===== */
document.getElementById("imgInput").onchange = e=>{
  const file = e.target.files[0];
  const img = new Image();
  img.onload = ()=>{
    const layer = {
      name:file.name,
      img,
      x:BASE_W/2,
      y:BASE_H/2,
      scale:1,
      rotate:0,
      float:0,
      speed:5
    };
    layers.unshift(layer);
    current = layer;
    refreshUI();
  };
  img.src = URL.createObjectURL(file);
};

/* ===== レイヤー一覧 ===== */
function refreshUI(){
  listEl.innerHTML="";
  layers.forEach((l,i)=>{
    const div=document.createElement("div");
    div.className="layer-item"+(l===current?" active":"");
    div.onclick=()=>{ current=l; refreshUI(); };

    const label=document.createElement("span");
    label.textContent=`${i+1}｜${l.name}`;
    div.appendChild(label);

    const up=document.createElement("button");
    up.textContent="▲";
    up.onclick=e=>{
      e.stopPropagation();
      if(i>0){ [layers[i-1],layers[i]]=[layers[i],layers[i-1]]; refreshUI(); }
    };
    div.appendChild(up);

    const down=document.createElement("button");
    down.textContent="▼";
    down.onclick=e=>{
      e.stopPropagation();
      if(i<layers.length-1){ [layers[i+1],layers[i]]=[layers[i],layers[i+1]]; refreshUI(); }
    };
    div.appendChild(down);

    listEl.appendChild(div);
  });

  if(current){
    xI.value=current.x;
    yI.value=current.y;
    sI.value=current.scale;
    rI.value=current.rotate;
    fI.value=current.float;
    spI.value=current.speed;
  }
}

/* ===== 数値反映 ===== */
[xI,yI,sI,rI,fI,spI].forEach(inp=>{
  inp.oninput=()=>{
    if(!current) return;
    current.x=+xI.value;
    current.y=+yI.value;
    current.scale=+sI.value;
    current.rotate=+rI.value;
    current.float=+fI.value;
    current.speed=+spI.value;
    refreshUI();
  };
});

/* ===== ドラッグ ===== */
let drag=false;
canvas.onmousedown=()=>drag=true;
canvas.onmouseup=()=>drag=false;
canvas.onmousemove=e=>{
  if(!drag||!current) return;
  const r=canvas.getBoundingClientRect();
  current.x=(e.clientX-r.left)*BASE_W/canvas.width;
  current.y=(e.clientY-r.top)*BASE_H/canvas.height;
  refreshUI();
};

/* ===== スナップショットログ ===== */
snapshotBtn.onclick=()=>{
  const time=new Date().toLocaleTimeString();
  let text=`[${time}] SNAPSHOT\nLAYERS (① top):\n\n`;
  layers.forEach((l,i)=>{
    text+=`${i+1} ${l.name}\n`;
    text+=`   x:${l.x} y:${l.y} s:${l.scale} r:${l.rotate} f:${l.float} sp:${l.speed}\n\n`;
  });
  const div=document.createElement("div");
  div.className="log-new";
  div.textContent=text.trim();
  logBox.prepend(div);
};

/* ===== 描画 ===== */
let start=performance.now();
function draw(){
  const t=(performance.now()-start)/1000;
  ctx.fillStyle="#555";
  ctx.fillRect(0,0,BASE_W,BASE_H);

  layers.slice().reverse().forEach(l=>{
    if(!l.img.complete) return;
    const fy=Math.sin(t*l.speed*SPEED_UNIT)*l.float*FLOAT_PX;
    ctx.save();
    ctx.translate(l.x,l.y+fy);
    ctx.rotate(l.rotate*Math.PI/180);
    ctx.scale(l.scale,l.scale);
    ctx.drawImage(l.img,-l.img.width/2,-l.img.height/2);
    ctx.restore();
  });
  requestAnimationFrame(draw);
}
requestAnimationFrame(draw);
</script>

</body>
</html>
