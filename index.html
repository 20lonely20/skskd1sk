<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>Game Editor Touch+BGM</title>

<style>
body{
  margin:0;
  display:flex;
  height:100vh;
  background:#222;
  color:#fff;
  font-family:sans-serif;
}
#canvasWrap{
  flex:1;
  display:flex;
  justify-content:center;
  align-items:center;
  background:#000;
  touch-action:none;
}
canvas{ background:#555; }

#panel{
  width:420px;
  padding:10px;
  background:#333;
  overflow:auto;
}
h3{ font-size:14px; margin:8px 0 4px; }
label{ font-size:12px; display:block; margin-top:6px; }
input,button{ width:100%; }

.layer-item{
  background:#444;
  padding:4px;
  margin-bottom:4px;
  font-size:11px;
  cursor:pointer;
}
.layer-item.active{ background:#666; }

#logBox{
  background:#111;
  font-size:11px;
  white-space:pre-wrap;
  padding:6px;
  max-height:200px;
  overflow:auto;
}
</style>
</head>

<body>

<div id="canvasWrap">
  <canvas id="canvas"></canvas>
</div>

<div id="panel">
  <label>画像追加 <input type="file" id="imgInput"></label>

  <h3>レイヤー一覧（①最前面）</h3>
  <div id="layerList"></div>

  <h3>BGM</h3>
  <label>BGMアップロード <input type="file" id="bgmInput"></label>
  <button id="playBgm">▶ 再生</button>
  <button id="stopBgm">■ 停止</button>
  <label>音量 <input type="range" min="0" max="1" step="0.01" id="bgmVol"></label>

  <button id="snapshotBtn">画面スナップショット保存</button>

  <h3>ログ</h3>
  <div id="logBox"></div>
</div>

<script>
/* ===== 基本 ===== */
const BASE_W=1280, BASE_H=720;
const FLOAT_PX=4, SPEED_UNIT=0.8;

const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const wrap=document.getElementById("canvasWrap");

/* ===== resize ===== */
function resize(){
  const r=wrap.getBoundingClientRect();
  const sc=Math.min(r.width/BASE_W,r.height/BASE_H);
  canvas.width=BASE_W*sc;
  canvas.height=BASE_H*sc;
  ctx.setTransform(sc,0,0,sc,0,0);
}
window.addEventListener("resize",resize);
resize();

/* ===== データ ===== */
let layers=[], current=null;

/* ===== BGM ===== */
const bgm=new Audio();
bgm.loop=true;
document.getElementById("bgmInput").onchange=e=>{
  bgm.src=URL.createObjectURL(e.target.files[0]);
};
document.getElementById("playBgm").onclick=()=>bgm.play();
document.getElementById("stopBgm").onclick=()=>bgm.pause();
document.getElementById("bgmVol").oninput=e=>bgm.volume=e.target.value;

/* ===== UI ===== */
const listEl=document.getElementById("layerList");
const logBox=document.getElementById("logBox");

/* ===== 画像追加 ===== */
document.getElementById("imgInput").onchange=e=>{
  const f=e.target.files[0];
  const img=new Image();
  img.onload=()=>{
    const l={name:f.name,img,x:BASE_W/2,y:BASE_H/2,scale:1,rotate:0,float:0,speed:3};
    layers.unshift(l); current=l; refreshUI();
  };
  img.src=URL.createObjectURL(f);
};

/* ===== レイヤーUI ===== */
function refreshUI(){
  listEl.innerHTML="";
  layers.forEach((l,i)=>{
    const d=document.createElement("div");
    d.className="layer-item"+(l===current?" active":"");
    d.textContent=`${i+1} ${l.name}`;
    d.onclick=()=>{current=l; refreshUI();};
    listEl.appendChild(d);
  });
}

/* ===== タッチ操作 ===== */
let pointers=new Map();
wrap.addEventListener("pointerdown",e=>{
  wrap.setPointerCapture(e.pointerId);
  pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
});
wrap.addEventListener("pointerup",e=>pointers.delete(e.pointerId));
wrap.addEventListener("pointercancel",e=>pointers.delete(e.pointerId));

wrap.addEventListener("pointermove",e=>{
  if(!current||!pointers.has(e.pointerId)) return;
  const prev=pointers.get(e.pointerId);
  const dx=e.clientX-prev.x;
  const dy=e.clientY-prev.y;
  pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});

  const rect=canvas.getBoundingClientRect();
  if(pointers.size===1){
    current.x+=dx*BASE_W/rect.width;
    current.y+=dy*BASE_H/rect.height;
  }
  if(pointers.size===2){
    const pts=[...pointers.values()];
    const dist=Math.hypot(pts[0].x-pts[1].x,pts[0].y-pts[1].y);
    current.scale+=dx*0.005;
    current.rotate+=dx*0.2;
  }
});

/* ===== スナップショット ===== */
snapshotBtn.onclick=()=>{
  let txt=`BGM volume:${bgm.volume}\nLAYERS:\n`;
  layers.forEach((l,i)=>{
    txt+=`${i+1} ${l.name} x:${l.x} y:${l.y} s:${l.scale} r:${l.rotate}\n`;
  });
  logBox.prepend(Object.assign(document.createElement("div"),{textContent:txt}));
};

/* ===== 描画 ===== */
let start=performance.now();
function draw(){
  const t=(performance.now()-start)/1000;
  ctx.fillStyle="#555";
  ctx.fillRect(0,0,BASE_W,BASE_H);
  layers.slice().reverse().forEach(l=>{
    if(!l.img.complete) return;
    const fy=Math.sin(t*l.speed*SPEED_UNIT)*l.float*FLOAT_PX;
    ctx.save();
    ctx.translate(l.x,l.y+fy);
    ctx.rotate(l.rotate*Math.PI/180);
    ctx.scale(l.scale,l.scale);
    ctx.drawImage(l.img,-l.img.width/2,-l.img.height/2);
    ctx.restore();
  });
  requestAnimationFrame(draw);
}
draw();
</script>

</body>
</html>
