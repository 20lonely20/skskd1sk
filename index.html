<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã€ã‚­ãƒ£ãƒ©1äººç”»é¢ã€‘</title>

  <style>
    :root{
      --VW: 1280;
      --VH: 720;
      --scale: 1;
    }

    html, body{
      width:100%;
      height:100%;
      margin:0;
      overflow:hidden;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background:#111;
    }

    .stage{
      position:fixed;
      inset:0;
      overflow:hidden;
      background:
        radial-gradient(1200px 600px at 50% 40%, rgba(255,255,255,.08), rgba(0,0,0,0)),
        linear-gradient(180deg, #1a1a1a, #0f0f0f);
    }

    .stage::before{
      content:"";
      position:absolute;
      inset:-40px;
      background-image: url("./ed04a2728cfb3679954121cdfc6c811a.jpg");
      background-size: cover;
      background-position: center;
      filter: blur(18px) saturate(1.05) brightness(.9);
      opacity: .55;
      transform: scale(1.05);
    }

    .viewport{
      position:absolute;
      left:50%;
      top:50%;
      width: calc(var(--VW) * 1px);
      height: calc(var(--VH) * 1px);
      transform: translate(-50%, -50%) scale(var(--scale));
      transform-origin: center center;
      pointer-events:auto;
    }

    .scene{
      position:relative;
      width:100%;
      height:100%;
      overflow:hidden;
      background:#000;
      user-select:none;
      border-radius: 10px;
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
    }

    .bg{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      z-index:0;
    }

    /* ğŸ§ ç«‹ã¡çµµï¼ˆJSã§ transform ä¸Šæ›¸ãã—ã¦ãµã‚ã‚†ã‚‰ï¼‰ */
    .chara{
      position:absolute;
      left:50%;
      top:3%;
      height:110%;
      width:auto;
      object-fit:contain;
      z-index:2;
      pointer-events:none;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
      transform-origin: top center;
      will-change: transform;
    }

    .windowWrap{
      position:absolute;
      left:50%;
      bottom:3%;
      transform:translateX(-50%);
      width:60%;
      max-width:840px;
      z-index:5;
      pointer-events:none;
    }
    .ui{
      width:100%;
      height:auto;
      display:block;
    }

    .nameBox{
      position:absolute;
      left:35px;
      top:30px;
      z-index:6;
      pointer-events:none;
    }
    .nameBox span{
      display:inline-block;
      background:#ff2b6a;
      color:#fff;
      padding:6px 14px;
      border-radius:12px;
      font-weight:700;
      font-size:18px;
      line-height:1.1;
      white-space:nowrap;
    }

    .textBox{
      position:absolute;
      left:55px;
      right:70px;
      top:70px;
      bottom:44px;
      z-index:6;
      pointer-events:none;
      color:#222;
      font-size:18px;
      line-height:1.65;
      white-space:pre-wrap;
      box-sizing:border-box;
    }

    /* ğŸ§© ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆãã®ã¾ã¾æ®‹ã™ï¼‰ */
    .sideBar{
      position:absolute;
      top:10%;
      bottom:14%;
      width:130px;
      display:flex;
      flex-direction:column;
      gap:18px;
      z-index:7;
      padding:10px;
      box-sizing:border-box;
      pointer-events:none;
      align-items:center;
    }
    .sideBar.left{ left:1.0%; }
    .sideBar.right{ right:1.0%; }

    .icon{
      width:110px;
      height:110px;
      object-fit:contain;
      display:block;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.18));
    }

    /* =========================
       ğŸ’¾ ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰UIï¼ˆä»®ï¼‰
       â€»å¾Œã§ã‚¢ã‚¤ã‚³ãƒ³ãƒœã‚¿ãƒ³ã«ç½®ãæ›ãˆOK
    ========================= */
    .saveBtn{
      position:absolute;
      right:16px;
      top:16px;
      z-index:20;
      pointer-events:auto;
      background: rgba(0,0,0,.55);
      color:#fff;
      border:1px solid rgba(255,255,255,.18);
      border-radius:12px;
      padding:10px 14px;
      font-weight:700;
      cursor:pointer;
      backdrop-filter: blur(6px);
    }

    .modalBg{
      position:absolute;
      inset:0;
      z-index:30;
      background: rgba(0,0,0,.55);
      display:none;
      pointer-events:auto;
    }
    .modalBg.show{ display:block; }

    .modal{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%, -50%);
      width: min(780px, 92%);
      background: rgba(20,20,20,.92);
      color:#fff;
      border:1px solid rgba(255,255,255,.15);
      border-radius:16px;
      padding:18px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
    }

    .modal h2{
      margin:0 0 8px 0;
      font-size:18px;
    }

    .note{
      margin:10px 0 14px 0;
      font-size:13px;
      line-height:1.6;
      color: rgba(255,255,255,.9);
    }
    .note strong{ color:#fff; }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin:10px 0;
    }

    .primary{
      background:#ff2b6a;
      color:#fff;
      border:none;
      border-radius:12px;
      padding:10px 14px;
      font-weight:800;
      cursor:pointer;
    }
    .ghost{
      background: rgba(255,255,255,.10);
      color:#fff;
      border:1px solid rgba(255,255,255,.15);
      border-radius:12px;
      padding:10px 14px;
      font-weight:700;
      cursor:pointer;
    }

    .field{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:10px;
      font-size:13px;
      color: rgba(255,255,255,.85);
    }

    input[type="text"]{
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.18);
      border-radius:10px;
      padding:10px 12px;
      color:#fff;
      outline:none;
      width: 240px;
    }

    input[type="file"]{
      color:#fff;
    }

    @media (prefers-reduced-motion: reduce){
      .chara{ transform: translateX(-50%) scale(1.10) !important; }
    }
  </style>
</head>

<body>
  <div class="stage">
    <div class="viewport">
      <div class="scene" role="application" aria-label="ã‚­ãƒ£ãƒ©1äººç”»é¢">

        <!-- èƒŒæ™¯ -->
        <img class="bg" src="./ed04a2728cfb3679954121cdfc6c811a.jpg" alt="èƒŒæ™¯" />

        <!-- å·¦ã‚¢ã‚¤ã‚³ãƒ³ -->
        <div class="sideBar left" aria-hidden="true">
          <img class="icon" src="./ç™ºæ³¨æ›¸.png" alt="">
          <img class="icon" src="./ãƒ€ãƒ³ãƒœãƒ¼ãƒ«.png" alt="">
          <img class="icon" src="./ç™ºæ³¨æ›¸.png" alt="">
        </div>

        <!-- å³ã‚¢ã‚¤ã‚³ãƒ³ -->
        <div class="sideBar right" aria-hidden="true">
          <img class="icon" src="./ãƒ€ãƒ³ãƒœãƒ¼ãƒ«.png" alt="">
          <img class="icon" src="./ç™ºæ³¨æ›¸.png" alt="">
          <img class="icon" src="./ãƒ€ãƒ³ãƒœãƒ¼ãƒ«.png" alt="">
        </div>

        <!-- ç«‹ã¡çµµ -->
        <img class="chara" src="./å…¨èº«ç«‹ã¡çµµ.png" alt="ã‚­ãƒ£ãƒ©ç«‹ã¡çµµ" />

        <!-- ä¼šè©±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ -->
        <div class="windowWrap">
          <img class="ui" src="./ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ä»®.png" alt="ä¼šè©±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦" />

          <div class="nameBox" aria-hidden="true">
            <span>æ©‹æœ¬</span>
          </div>

          <div class="textBox" aria-live="polite">
ã“ã‚Œã¯ã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚­ã‚¹ãƒˆã§ã™ã€‚ä»Šæ—¥ã‚‚è‰¯ã„å¤©æ°—ã ãªãğŸŒâœ¨
          </div>
        </div>

        <!-- ğŸ’¾ ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰ï¼ˆä»®ãƒœã‚¿ãƒ³ï¼‰ -->
        <button class="saveBtn" id="openSave">ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰</button>

        <!-- ğŸ’¾ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div class="modalBg" id="modalBg" aria-hidden="true">
          <div class="modal" role="dialog" aria-modal="true" aria-label="ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰">
            <h2>ğŸ’¾ ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ï¼ˆæ›¸ãå‡ºã—ï¼èª­ã¿è¾¼ã¿ï¼‰</h2>

            <div class="note">
              âš ï¸ <strong>æ³¨æ„</strong><br>
              ç´ äººåˆ¶ä½œã®åŒäººã‚²ãƒ¼ãƒ ã«ã¤ãã€iPhoneã®è¨­å®šãªã©ã§Safariã®å±¥æ­´ï¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ã‚µã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹ã¨ã€
              ãƒ–ãƒ©ã‚¦ã‚¶å†…ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚<br><br>
              âœ… å®‰å…¨ã®ãŸã‚ã€å®šæœŸçš„ã«ã€Œã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãå‡ºã—ã€ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒ—ãƒªç­‰ã«ä¿å­˜ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚<br>
              ç¶šãã‚’éŠã¶ã¨ãã¯ã€Œã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ã€ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã¶ã¨å¾©å¸°ã§ãã¾ã™ã€‚
            </div>

            <div class="field">
              ğŸ‘¤ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒãƒ¼ãƒ ï¼š
              <input type="text" id="playerName" placeholder="ä¾‹ï¼šã¯ãªã“" />
              <button class="ghost" id="saveName">ä¿å­˜</button>
            </div>

            <div class="row">
              <button class="primary" id="exportBtn">â¬‡ï¸ ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãå‡ºã—</button>
              <label class="ghost" style="display:inline-flex; gap:8px; align-items:center;">
                â¬†ï¸ ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
                <input type="file" id="importFile" accept="application/json" style="width:220px;">
              </label>
              <button class="ghost" id="closeSave">é–‰ã˜ã‚‹</button>
            </div>

            <div class="note" id="statusText" style="margin-top:8px; opacity:.9;"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    // =========================
    // ğŸ“ scale = min(w/1280, h/720)
    // =========================
    (function(){
      const root = document.documentElement;
      const VW = 1280;
      const VH = 720;

      function updateScale(){
        const w = window.innerWidth;
        const h = window.innerHeight;
        const s = Math.min(w / VW, h / VH);
        root.style.setProperty("--scale", String(s));
      }

      window.addEventListener("resize", updateScale, { passive: true });
      updateScale();
    })();

    // =========================
    // ğŸŒ¸ ç«‹ã¡çµµãµã‚ã‚†ã‚‰ï¼ˆé€Ÿã‚ãƒ»æºã‚Œå°ã•ã‚ï¼‰
    // =========================
    (function(){
      const chara = document.querySelector(".chara");
      const baseScale = 1.10;

      const speed = 0.022; // é€Ÿã‚ï¼ˆ0.018ã€œ0.030ï¼‰
      const ampY  = 5;     // æºã‚Œå¹…ï¼ˆå°ã•ã‚ï¼‰
      const ampX  = 2;
      const ampR  = 0.25;

      let t = 0;
      function tick(){
        t += speed;
        const y = Math.sin(t) * ampY;
        const x = Math.sin(t * 0.73) * ampX;
        const r = Math.sin(t * 0.49) * ampR;

        chara.style.transform =
          `translateX(-50%) translate(${x}px, ${-y}px) rotate(${r}deg) scale(${baseScale})`;

        requestAnimationFrame(tick);
      }

      if (chara.complete) tick();
      else chara.addEventListener("load", tick, { once: true });
    })();

    // =========================
    // ğŸ’¾ ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ï¼šæ›¸ãå‡ºã—ï¼èª­ã¿è¾¼ã¿
    // localStorage ã‚’ä½¿ç”¨ï¼ˆåˆå¿ƒè€…å‘ã‘ã«ç°¡å˜ï¼‰
    // =========================
    (function(){
      const GAME_TITLE = "ã‚²ãƒ¼ãƒ ã‚¿ã‚¤ãƒˆãƒ«"; // â†ã“ã“ã ã‘å¥½ãã«å¤‰ãˆã¦OK
      const KEY_PLAYER = "mygame_playerName";
      const KEY_SAVE   = "mygame_saveState";

      const openBtn = document.getElementById("openSave");
      const modalBg = document.getElementById("modalBg");
      const closeBtn = document.getElementById("closeSave");
      const exportBtn = document.getElementById("exportBtn");
      const importFile = document.getElementById("importFile");
      const playerNameInput = document.getElementById("playerName");
      const saveNameBtn = document.getElementById("saveName");
      const statusText = document.getElementById("statusText");

      function setStatus(msg){
        statusText.textContent = msg;
      }

      function openModal(){
        modalBg.classList.add("show");
        modalBg.setAttribute("aria-hidden", "false");
      }
      function closeModal(){
        modalBg.classList.remove("show");
        modalBg.setAttribute("aria-hidden", "true");
      }

      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒãƒ¼ãƒ ã®ä¿å­˜/å¾©å…ƒ
      const storedName = localStorage.getItem(KEY_PLAYER) || "";
      playerNameInput.value = storedName;

      saveNameBtn.addEventListener("click", () => {
        localStorage.setItem(KEY_PLAYER, playerNameInput.value.trim());
        setStatus("âœ… ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒãƒ¼ãƒ ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
      });

      openBtn.addEventListener("click", () => {
        setStatus("");
        openModal();
      });
      closeBtn.addEventListener("click", closeModal);
      modalBg.addEventListener("click", (e) => {
        if (e.target === modalBg) closeModal();
      });

      // âœ… ã‚ãªãŸã®ã‚²ãƒ¼ãƒ ã®é€²è¡Œãƒ‡ãƒ¼ã‚¿ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰
      // ã“ã“ã‚’æœ¬ç•ªã®å¤‰æ•°ã«ç½®ãæ›ãˆã‚‹ã ã‘ã§å®Œæˆ
      function getCurrentGameState(){
        return {
          sceneId: 1,
          lineIndex: 12,
          flags: { metA: true },
          // ä¾‹ï¼šæ‰€æŒã‚¢ã‚¤ãƒ†ãƒ ã‚„å¥½æ„Ÿåº¦ãªã©ã‚‚ã“ã“ã«å…¥ã‚Œã‚‹
        };
      }

      function applyGameState(state){
        // æœ¬ç•ªã§ã¯ã“ã“ã§ UI ã‚„é€²è¡Œå¤‰æ•°ã‚’å¾©å…ƒã™ã‚‹
        // ã„ã¾ã¯ã‚µãƒ³ãƒ—ãƒ«ã§è¡¨ç¤ºã ã‘
        setStatus("âœ… èª­ã¿è¾¼ã¿æˆåŠŸï¼šsceneId=" + state.sceneId + " / lineIndex=" + state.lineIndex);
      }

      function pad2(n){ return String(n).padStart(2, "0"); }

      function makeFileName(){
        const nameRaw = (playerNameInput.value.trim() || "åç„¡ã—");
        // ãƒ•ã‚¡ã‚¤ãƒ«åã«ä½¿ãˆãªã„æ–‡å­—ã‚’é¿ã‘ã‚‹ï¼ˆ: / \ ãªã©ï¼‰
        const safeName = nameRaw.replace(/[\\\/:*?"<>|]/g, " ");

        const d = new Date();
        const Y = d.getFullYear();
        const M = pad2(d.getMonth() + 1);
        const D = pad2(d.getDate());
        const h = pad2(d.getHours());
        const m = pad2(d.getMinutes());

        // å¸Œæœ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼š
        // ã€ã‚²ãƒ¼ãƒ ã‚¿ã‚¤ãƒˆãƒ«ã€‘ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒãƒ¼ãƒ ï¼šYYYYå¹´MMæœˆDDæ—¥ï¼šHHæ™‚MMåˆ†.json
        return `ã€${GAME_TITLE}ã€‘${safeName}ï¼š${Y}å¹´${M}æœˆ${D}æ—¥ï¼š${h}æ™‚${m}åˆ†.json`;
      }

      // â¬‡ï¸ æ›¸ãå‡ºã—
      exportBtn.addEventListener("click", () => {
        const payload = {
          version: 1,
          gameTitle: GAME_TITLE,
          playerName: playerNameInput.value.trim() || "åç„¡ã—",
          savedAtISO: new Date().toISOString(),
          state: getCurrentGameState(),
        };

        // ã¤ã„ã§ã«ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ã‚‚ä¿å­˜ï¼ˆä»»æ„ï¼‰
        localStorage.setItem(KEY_SAVE, JSON.stringify(payload));

        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = makeFileName();
        document.body.appendChild(a);
        a.click();
        a.remove();

        URL.revokeObjectURL(url);

        setStatus("â¬‡ï¸ æ›¸ãå‡ºã—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒ—ãƒªï¼ˆã¾ãŸã¯ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰ã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");
      });

      // â¬†ï¸ èª­ã¿è¾¼ã¿
      importFile.addEventListener("change", async () => {
        const file = importFile.files && importFile.files[0];
        if (!file) return;

        try{
          const text = await file.text();
          const data = JSON.parse(text);

          if (!data || typeof data !== "object" || !data.state){
            throw new Error("ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒé•ã„ã¾ã™ã€‚");
          }

          // ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ã‚‚åæ˜ ï¼ˆä»»æ„ï¼‰
          localStorage.setItem(KEY_SAVE, JSON.stringify(data));

          applyGameState(data.state);
        }catch(err){
          setStatus("âŒ èª­ã¿è¾¼ã¿å¤±æ•—ï¼š" + (err && err.message ? err.message : String(err)));
        }finally{
          // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦é¸ã¹ã‚‹ã‚ˆã†ã«ã‚¯ãƒªã‚¢
          importFile.value = "";
        }
      });
    })();
  </script>
</body>
</html>
