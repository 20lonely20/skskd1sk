<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Local SNS â€” Mystic Purple</title>
  <style>
    :root{
      --bg0:#070511;
      --bg1:#120a2b;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.09);
      --line: rgba(255,255,255,.10);
      --txt:#efe9ff;
      --muted: rgba(239,233,255,.72);
      --muted2: rgba(239,233,255,.55);
      --a:#b98cff;
      --a2:#7b5cff;
      --hot:#ff67c7;
      --ok:#66ffdd;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --blur: blur(12px);
      --r: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans JP", "Hiragino Sans", "Yu Gothic", sans-serif;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--txt);
      background:
        radial-gradient(1000px 600px at 15% 10%, rgba(185,140,255,.25), transparent 55%),
        radial-gradient(900px 600px at 80% 15%, rgba(255,103,199,.18), transparent 55%),
        radial-gradient(900px 700px at 60% 95%, rgba(102,255,221,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 22px 16px 70px;
    }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 14px;
    }

    .brand{
      display:flex; flex-direction:column; gap:6px;
    }
    .brand h1{
      margin:0;
      font-size: 20px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .orb{
      width: 16px; height: 16px;
      border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.15) 28%, rgba(185,140,255,.95) 55%, rgba(123,92,255,.2) 72%, transparent 75%);
      box-shadow: 0 0 18px rgba(185,140,255,.55), 0 0 28px rgba(255,103,199,.18);
    }
    .sub{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.4;
    }

    .topActions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      background: linear-gradient(180deg, rgba(185,140,255,.22), rgba(123,92,255,.12));
      border: 1px solid rgba(185,140,255,.25);
      color: var(--txt);
      border-radius: 999px;
      padding: 10px 12px;
      cursor:pointer;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
      user-select:none;
      font-size: 13px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.22); }
    .btn:active{ transform: translateY(0); }
    .btn.secondary{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.12);
    }

    .grid{
      display:grid;
      grid-template-columns: 340px 1fr;
      gap: 14px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: var(--blur);
      overflow:hidden;
    }
    .card .hd{
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .card .hd h2{
      margin:0;
      font-size: 14px;
      letter-spacing:.2px;
      color: rgba(239,233,255,.92);
      display:flex; align-items:center; gap:8px;
    }
    .pill{
      font-family: var(--mono);
      font-size: 11px;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.15);
      color: rgba(239,233,255,.78);
    }

    .section{
      padding: 14px;
    }
    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 10px 0 6px;
    }
    input[type="text"], textarea{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color: var(--txt);
      outline:none;
      font-size: 13px;
    }
    textarea{ min-height: 92px; resize: vertical; }
    input[type="file"]{
      width:100%;
      color: var(--muted);
      font-size: 12px;
    }
    .row{
      display:flex; gap:10px;
    }
    .row > *{ flex:1; }

    .profileTop{
      display:flex; gap: 12px; align-items:flex-start;
    }
    .avatar{
      width:56px; height:56px; border-radius: 16px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.9), rgba(255,255,255,.15) 30%, rgba(185,140,255,.95) 62%, rgba(255,103,199,.22) 78%, rgba(0,0,0,.0) 80%),
        linear-gradient(135deg, rgba(123,92,255,.2), rgba(0,0,0,0));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 0 22px rgba(185,140,255,.35);
    }
    .profileMeta{
      flex:1;
    }
    .nameLine{
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap:wrap;
    }
    .nameLine .name{
      font-weight: 700;
      letter-spacing:.2px;
    }
    .nameLine .uid{
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
    }
    .bio{
      margin-top: 8px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .stats{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 12px;
    }
    .stat{
      background: rgba(0,0,0,.16);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px;
      text-align:center;
    }
    .stat .n{
      font-weight: 800;
      letter-spacing:.2px;
    }
    .stat .t{
      font-size: 11px;
      color: var(--muted2);
      margin-top: 4px;
    }

    .hint{
      font-size: 11px;
      color: var(--muted2);
      line-height: 1.55;
      margin-top: 10px;
    }

    /* feed */
    .feed{
      display:flex;
      flex-direction:column;
      gap: 10px;
      padding: 14px;
    }
    .post{
      background: var(--card2);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding: 12px 12px 10px;
      box-shadow: 0 10px 35px rgba(0,0,0,.35);
      overflow:hidden;
      position:relative;
    }
    .post::before{
      content:"";
      position:absolute;
      inset:-1px;
      pointer-events:none;
      background: radial-gradient(500px 140px at 10% 0%, rgba(185,140,255,.15), transparent 60%),
                  radial-gradient(520px 160px at 90% 10%, rgba(255,103,199,.12), transparent 55%);
      opacity:.9;
    }
    .post > *{ position:relative; }

    .postHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
    }
    .postUser{
      display:flex; align-items:center; gap: 10px;
      min-width: 0;
    }
    .miniAv{
      width: 36px; height: 36px; border-radius: 14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.85), rgba(255,255,255,.10) 28%, rgba(185,140,255,.9) 62%, rgba(0,0,0,0) 80%),
        linear-gradient(135deg, rgba(123,92,255,.15), rgba(0,0,0,0));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 0 16px rgba(185,140,255,.25);
      flex: 0 0 auto;
    }
    .who{
      min-width:0;
    }
    .who .line1{
      display:flex; gap: 8px; align-items:baseline;
      flex-wrap:wrap;
    }
    .who .line1 .n{
      font-weight: 800;
      font-size: 13px;
    }
    .who .line1 .u{
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
    }
    .time{
      font-family: var(--mono);
      color: var(--muted2);
      font-size: 11px;
      white-space:nowrap;
    }

    .body{
      white-space: pre-wrap;
      line-height: 1.65;
      font-size: 14px;
      color: rgba(239,233,255,.94);
    }

    .media{
      margin-top: 10px;
      border-radius: 16px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .media img, .media video{
      display:block;
      width: 100%;
      max-height: 420px;
      object-fit: cover;
    }

    .react{
      display:flex;
      gap: 10px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,.08);
      color: var(--muted);
      font-size: 12px;
    }
    .rbtn{
      display:inline-flex;
      align-items:center;
      gap: 7px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, border-color .2s ease;
    }
    .rbtn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.18); }
    .rbtn:active{ transform: translateY(0); }
    .rbtn .ic{ filter: drop-shadow(0 0 8px rgba(185,140,255,.22)); }
    .rbtn .num{
      font-family: var(--mono);
      color: rgba(239,233,255,.85);
      min-width: 3ch;
      text-align:right;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.45);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(239,233,255,.92);
      padding: 10px 12px;
      border-radius: 999px;
      backdrop-filter: var(--blur);
      box-shadow: 0 18px 50px rgba(0,0,0,.55);
      font-size: 12px;
      opacity: 0;
      pointer-events:none;
      transition: opacity .25s ease, transform .25s ease;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-2px);
    }
    .small{
      font-size: 11px;
      color: var(--muted2);
    }
    .danger{
      color: rgba(255,180,215,.92);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1><span class="orb"></span> My Local SNS</h1>
        <div class="sub">å®Œå…¨ãƒ­ãƒ¼ã‚«ãƒ« / å¤–éƒ¨é€šä¿¡ã‚¼ãƒ­ / ã€ŒæŠ•ç¨¿ã—ãŸæ„Ÿã€ã¨ã€Œåå¿œãŒæ¥ãŸæ„Ÿã€ã ã‘ã‚’é™ã‹ã«è£œçµ¦ã™ã‚‹ ğŸ’œ</div>
      </div>
      <div class="topActions">
        <button class="btn secondary" id="openTL">ğŸœ‚ TLã‚’åˆ¥çª“ã§é–‹ã</button>
        <button class="btn" id="exportBtn">âŸ¡ ãƒ‡ãƒ¼ã‚¿æ›¸ãå‡ºã—</button>
        <button class="btn secondary" id="importBtn">âŸ¡ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿</button>
        <input type="file" id="importFile" accept="application/json" style="display:none" />
        <button class="btn secondary" id="wipeBtn">ğŸ—‘ï¸ å…¨æ¶ˆå»</button>
      </div>
    </header>

    <div class="grid">
      <!-- left -->
      <section class="card">
        <div class="hd">
          <h2>ğŸœ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
          <span class="pill" id="localTag">file:// local</span>
        </div>
        <div class="section">
          <div class="profileTop">
            <div class="avatar" aria-hidden="true"></div>
            <div class="profileMeta">
              <div class="nameLine">
                <div class="name" id="pNameView">ã‚ãªãŸ</div>
                <div class="uid" id="pIdView">@you</div>
              </div>
              <div class="bio" id="pBioView">ã“ã“ã¯å®‰å…¨ãªç´«ã®éƒ¨å±‹ã€‚å¤–ã¯è¦‹ãªã„ã€‚ã“ã“ã ã‘ã§å›å¾©ã™ã‚‹ã€‚</div>
            </div>
          </div>

          <div class="stats">
            <div class="stat"><div class="n" id="stPosts">0</div><div class="t">posts</div></div>
            <div class="stat"><div class="n" id="stFollows">12</div><div class="t">following</div></div>
            <div class="stat"><div class="n" id="stFollowers">128</div><div class="t">followers</div></div>
          </div>

          <div class="hint">
            â€»æ•°å­—ã¯ã€Œç¾å®Ÿã€ã˜ã‚ƒãªãã¦ã€Œä½“æ„Ÿã€ç”¨ã€‚ã“ã“ã¯å‰µä½œå›å¾©è£…ç½®ã€‚<br/>
            â€»ã“ã®ãƒšãƒ¼ã‚¸ã«ã¯ <b>ãƒªãƒ—è¡¨ç¤ºã¯ä¸€åˆ‡ã‚ã‚Šã¾ã›ã‚“</b>ï¼ˆè»½é‡åŒ–ï¼‰ã€‚
          </div>

          <hr style="border:0;border-top:1px solid rgba(255,255,255,.08); margin:14px 0;">

          <h3 style="margin:0 0 8px; font-size:13px; color:rgba(239,233,255,.92);">ç·¨é›†</h3>

          <label>è¡¨ç¤ºå</label>
          <input type="text" id="pName" placeholder="ä¾‹ï¼šã‚ãªãŸ" />

          <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆ@ã‹ã‚‰ï¼‰</label>
          <input type="text" id="pId" placeholder="ä¾‹ï¼šyou" />

          <label>è‡ªå·±ç´¹ä»‹</label>
          <textarea id="pBio" placeholder="ã“ã“ã¯å®‰å…¨ã€‚å‰µä½œã®ãŸã‚ã®ç´«ã®é¿é›£æ‰€ã€‚"></textarea>

          <div class="row">
            <div>
              <label>ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼</label>
              <input type="text" id="pFollowers" placeholder="ä¾‹ï¼š128" />
            </div>
            <div>
              <label>ãƒ•ã‚©ãƒ­ãƒ¼</label>
              <input type="text" id="pFollowing" placeholder="ä¾‹ï¼š12" />
            </div>
          </div>

          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn" id="saveProfile">ğŸ’¾ ä¿å­˜</button>
            <button class="btn secondary" id="seedCounts">âœ¨ åå¿œã‚’å°‘ã—ã ã‘å¢—ã‚„ã™</button>
          </div>
          <div class="small" style="margin-top:10px;">
            åå¿œã®â€œã˜ã‚ä¼¸ã³â€ã¯è‡ªå‹•ã§ç™ºç”Ÿã—ã¾ã™ï¼ˆå®Œå…¨ãƒ­ãƒ¼ã‚«ãƒ«ï¼‰ã€‚ã‚ãªãŸãŒæŠ¼ã—ã¦ã‚‚OKã€‚
          </div>
        </div>
      </section>

      <!-- right -->
      <section class="card">
        <div class="hd">
          <h2>ğŸœƒ æŠ•ç¨¿</h2>
          <span class="pill" id="postCountPill">0 / 10</span>
        </div>

        <div class="section">
          <label>æœ¬æ–‡</label>
          <textarea id="postText" placeholder="â€¦ç´«ã®éƒ¨å±‹ã«æŠ•ã’ã‚‹ã€‚å¤–ã«ã¯å‡ºãªã„ã€‚"></textarea>

          <label>ç”»åƒ/å‹•ç”»ï¼ˆä»»æ„ï¼‰</label>
          <input type="file" id="postMedia" accept="image/*,video/*" />

          <div class="small" id="mediaNote" style="margin-top:8px;">
            ç”»åƒã¯å®¹é‡ãŒè¨±ã™ç¯„å›²ã§ä¿å­˜ã€‚å‹•ç”»ã¯å¤§ãã„å ´åˆã€Œãã®å ´ã ã‘ã€æ‰±ã„ã«ãªã‚Šã¾ã™ï¼ˆå®‰å…¨ãƒ»è»½é‡å„ªå…ˆï¼‰ã€‚
          </div>

          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn" id="addPost">ğŸœ„ æŠ•ç¨¿ã™ã‚‹</button>
            <button class="btn secondary" id="clearDraft">ğŸ«§ ä¸‹æ›¸ãæ¶ˆå»</button>
          </div>
        </div>

        <div class="hd" style="border-top:1px solid rgba(255,255,255,.08);">
          <h2>ğŸœ ã‚ãªãŸã®æŠ•ç¨¿ï¼ˆæœ€æ–°10ä»¶ï¼‰</h2>
          <span class="pill">ãƒªãƒ—è¡¨ç¤ºãªã—</span>
        </div>
        <div class="feed" id="feed"></div>
      </section>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(() => {
  // ---------- storage keys ----------
  const K = {
    profile: "mysticSNS_profile_v1",
    posts: "mysticSNS_posts_v1",
    draft: "mysticSNS_draft_v1",
    bump: "mysticSNS_bump_v1"
  };

  const MAX_POSTS = 10;
  const VIDEO_PERSIST_LIMIT = 2.0 * 1024 * 1024; // 2MBä»¥ä¸‹ãªã‚‰dataURLä¿å­˜ï¼ˆãã‚Œä»¥ä¸Šã¯ä¸€æ™‚æ‰±ã„æ¨å¥¨ï¼‰
  const IMG_PERSIST_LIMIT   = 1.7 * 1024 * 1024; // ç”»åƒã‚‚å¤§ãã™ãã‚‹ã¨localStorageåœ§è¿«ã™ã‚‹ã®ã§è»½ãåˆ¶é™

  // ---------- utils ----------
  const $ = (id) => document.getElementById(id);
  const nowISO = () => new Date().toISOString();
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
  const randInt = (a,b) => Math.floor(Math.random()*(b-a+1))+a;

  function toast(msg, ms=1600){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    clearTimeout(toast._tm);
    toast._tm = setTimeout(() => t.classList.remove("show"), ms);
  }

  function loadJSON(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return fallback;
      return JSON.parse(raw);
    }catch(e){ return fallback; }
  }
  function saveJSON(key, val){
    localStorage.setItem(key, JSON.stringify(val));
  }

  function safeNumberText(v, def){
    const n = parseInt(String(v||"").replace(/[^\d]/g,""), 10);
    return Number.isFinite(n) ? String(n) : String(def);
  }

  // ---------- profile ----------
  const defaultProfile = {
    name: "ã‚ãªãŸ",
    id: "you",
    bio: "ã“ã“ã¯å®‰å…¨ãªç´«ã®éƒ¨å±‹ã€‚å¤–ã¯è¦‹ãªã„ã€‚ã“ã“ã ã‘ã§å›å¾©ã™ã‚‹ã€‚",
    followers: "128",
    following: "12"
  };

  function getProfile(){
    return { ...defaultProfile, ...loadJSON(K.profile, {}) };
  }
  function setProfile(p){
    saveJSON(K.profile, p);
  }

  function renderProfile(){
    const p = getProfile();
    $("pNameView").textContent = p.name || defaultProfile.name;
    $("pIdView").textContent = "@" + (p.id || defaultProfile.id);
    $("pBioView").textContent = p.bio || defaultProfile.bio;

    $("pName").value = p.name || "";
    $("pId").value = p.id || "";
    $("pBio").value = p.bio || "";
    $("pFollowers").value = safeNumberText(p.followers, 128);
    $("pFollowing").value = safeNumberText(p.following, 12);

    $("stFollowers").textContent = safeNumberText(p.followers, 128);
    $("stFollows").textContent = safeNumberText(p.following, 12);

    const posts = getPosts();
    $("stPosts").textContent = String(posts.length);
  }

  // ---------- posts ----------
  function getPosts(){
    return loadJSON(K.posts, []);
  }
  function setPosts(posts){
    saveJSON(K.posts, posts);
  }

  function fmtTime(iso){
    const d = new Date(iso);
    const pad = (n)=>String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function computeDefaultReacts(){
    // æŠ•ç¨¿ç›´å¾Œã®ã€ŒåˆæœŸã®æ°—é…ã€
    const base = randInt(0, 6);
    return {
      like: base + randInt(0, 3),
      repost: randInt(0, 2),
      reply: randInt(0, 3) // è¡¨ç¤ºã¯ã™ã‚‹ãŒæœ¬æ–‡ãƒªãƒ—ã¯ç„¡ã—
    };
  }

  function updatePill(){
    const n = getPosts().length;
    $("postCountPill").textContent = `${n} / ${MAX_POSTS}`;
    $("stPosts").textContent = String(n);
  }

  function makePostEl(post, profile){
    const el = document.createElement("article");
    el.className = "post";
    el.dataset.id = post.id;

    el.innerHTML = `
      <div class="postHead">
        <div class="postUser">
          <div class="miniAv" aria-hidden="true"></div>
          <div class="who">
            <div class="line1">
              <span class="n"></span>
              <span class="u"></span>
            </div>
            <div class="time"></div>
          </div>
        </div>
        <div class="time"></div>
      </div>

      <div class="body"></div>

      <div class="media" style="display:none"></div>

      <div class="react">
        <div class="rbtn" data-act="like" title="ã„ã„ã­">
          <span class="ic">â¤ï¸</span><span class="num" data-num="like">0</span>
        </div>
        <div class="rbtn" data-act="repost" title="ãƒªãƒã‚¹ãƒˆ">
          <span class="ic">ğŸ”</span><span class="num" data-num="repost">0</span>
        </div>
        <div class="rbtn" data-act="reply" title="è¿”ä¿¡ï¼ˆæœ¬æ–‡ã¯è¡¨ç¤ºã—ã¾ã›ã‚“ï¼‰">
          <span class="ic">ğŸ’¬</span><span class="num" data-num="reply">0</span>
        </div>
        <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
          <span class="pill" style="padding:6px 10px;">ID: <span style="font-family:var(--mono)">${post.id.slice(-6)}</span></span>
        </div>
      </div>
    `;

    const name = profile?.name || "ã‚ãªãŸ";
    const uid = "@" + (profile?.id || "you");
    el.querySelector(".who .n").textContent = name;
    el.querySelector(".who .u").textContent = uid;
    el.querySelectorAll(".time").forEach(t => t.textContent = fmtTime(post.time));
    el.querySelector(".body").textContent = post.text || "";

    const media = el.querySelector(".media");
    if(post.media && post.media.type && post.media.src){
      media.style.display = "block";
      if(post.media.type.startsWith("image/")){
        const img = document.createElement("img");
        img.src = post.media.src;
        img.alt = "image";
        media.appendChild(img);
      } else if(post.media.type.startsWith("video/")){
        const v = document.createElement("video");
        v.src = post.media.src;
        v.controls = true;
        v.playsInline = true;
        media.appendChild(v);
      }
    }

    // reaction counts
    const likeN = el.querySelector('[data-num="like"]');
    const repN  = el.querySelector('[data-num="repost"]');
    const rplN  = el.querySelector('[data-num="reply"]');
    likeN.textContent = String(post.react?.like ?? 0);
    repN.textContent  = String(post.react?.repost ?? 0);
    rplN.textContent  = String(post.react?.reply ?? 0);

    // manual bump (also persists)
    el.querySelectorAll(".rbtn").forEach(btn => {
      btn.addEventListener("click", () => {
        const act = btn.dataset.act;
        bumpReact(post.id, act, 1);
        const updated = getPosts().find(p => p.id === post.id);
        if(updated){
          likeN.textContent = String(updated.react.like);
          repN.textContent  = String(updated.react.repost);
          rplN.textContent  = String(updated.react.reply);
        }
      });
    });

    return el;
  }

  function renderFeed(){
    const feed = $("feed");
    feed.innerHTML = "";
    const p = getProfile();
    const posts = getPosts()
      .slice()
      .sort((a,b)=> (b.time||"").localeCompare(a.time||"")); // æœ€æ–°ä¸Š

    posts.forEach(post => feed.appendChild(makePostEl(post, p)));
    updatePill();
  }

  // ---------- reaction "slow growth" ----------
  // idea: periodically choose a few posts and increment counts slightly. Persist to localStorage.
  function bumpReact(postId, act, amount){
    const posts = getPosts();
    const idx = posts.findIndex(p => p.id === postId);
    if(idx < 0) return;

    const p = posts[idx];
    p.react = p.react || { like:0, repost:0, reply:0 };
    if(!(act in p.react)) return;

    p.react[act] = clamp((p.react[act]||0) + amount, 0, 999999);
    posts[idx] = p;
    setPosts(posts);
  }

  function autoBumpTick(){
    const posts = getPosts();
    if(!posts.length) return;

    // pick 1ã€œ3 posts to bump
    const k = randInt(1, Math.min(3, posts.length));
    for(let i=0;i<k;i++){
      const target = posts[randInt(0, posts.length-1)];
      if(!target) continue;

      // probabilities tuned to "ã˜ã‚ã€œ"
      const roll = Math.random();
      if(roll < 0.62){
        bumpReact(target.id, "like", randInt(1,2));
      } else if(roll < 0.84){
        bumpReact(target.id, "reply", randInt(0,1)); // 0ã‚‚ã‚ã‚‹ï¼å¢—ãˆãªã„æ™‚ã‚‚ã‚ã‚‹
      } else {
        bumpReact(target.id, "repost", 1);
      }
    }

    // update visible numbers only (cheap)
    document.querySelectorAll(".post").forEach(el => {
      const id = el.dataset.id;
      const p = getPosts().find(x => x.id === id);
      if(!p) return;
      el.querySelector('[data-num="like"]').textContent   = String(p.react.like);
      el.querySelector('[data-num="repost"]').textContent = String(p.react.repost);
      el.querySelector('[data-num="reply"]').textContent  = String(p.react.reply);
    });
  }

  function startAutoBump(){
    // random-ish interval 3sã€œ12s
    const run = () => {
      autoBumpTick();
      const next = randInt(3000, 12000);
      setTimeout(run, next);
    };
    setTimeout(run, randInt(1800, 4200));
  }

  // ---------- draft ----------
  function loadDraft(){
    const d = loadJSON(K.draft, { text:"" });
    $("postText").value = d.text || "";
  }
  function saveDraft(){
    saveJSON(K.draft, { text: $("postText").value || "" });
  }

  // ---------- media handling ----------
  function readFileAsDataURL(file){
    return new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onload = () => resolve(fr.result);
      fr.onerror = () => reject(fr.error);
      fr.readAsDataURL(file);
    });
  }

  // ---------- actions ----------
  $("saveProfile").addEventListener("click", () => {
    const p = {
      name: ($("pName").value || "ã‚ãªãŸ").trim(),
      id: ($("pId").value || "you").trim().replace(/^@/,""),
      bio: ($("pBio").value || "").trim(),
      followers: safeNumberText($("pFollowers").value, 128),
      following: safeNumberText($("pFollowing").value, 12),
    };
    setProfile(p);
    renderProfile();
    renderFeed();
    toast("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ ğŸ’¾");
  });

  $("seedCounts").addEventListener("click", () => {
    const posts = getPosts();
    if(!posts.length){ toast("æŠ•ç¨¿ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“"); return; }
    const n = randInt(1, Math.min(3, posts.length));
    for(let i=0;i<n;i++){
      const t = posts[randInt(0, posts.length-1)];
      bumpReact(t.id, "like", randInt(2,6));
      if(Math.random()<.3) bumpReact(t.id, "repost", 1);
      if(Math.random()<.5) bumpReact(t.id, "reply", randInt(1,2));
    }
    renderFeed();
    toast("â€¦ã©ã“ã‹ã§èª°ã‹ãŒè¦‹ã¦ãŸæ°—é… âœ¨");
  });

  $("clearDraft").addEventListener("click", () => {
    $("postText").value = "";
    $("postMedia").value = "";
    saveDraft();
    toast("ä¸‹æ›¸ãã‚’æ¶ˆã—ã¾ã—ãŸ ğŸ«§");
  });

  $("postText").addEventListener("input", () => saveDraft());

  $("addPost").addEventListener("click", async () => {
    const text = ($("postText").value || "").trim();
    const file = $("postMedia").files?.[0] || null;

    if(!text && !file){
      toast("æœ¬æ–‡ã‹ãƒ¡ãƒ‡ã‚£ã‚¢ã‚’å…¥ã‚Œã¦ã­");
      return;
    }

    const id = "p_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    const post = {
      id,
      time: nowISO(),
      text,
      react: computeDefaultReacts(),
      media: null
    };

    // media
    if(file){
      const isImg = file.type.startsWith("image/");
      const isVid = file.type.startsWith("video/");
      const size = file.size || 0;

      try{
        if(isImg){
          if(size > IMG_PERSIST_LIMIT){
            toast("ç”»åƒãŒå¤§ãã‚ã§ã™ã€‚è»½é‡åŒ–ã®ãŸã‚ç¸®å°æ¨å¥¨ï¼ˆãŸã ã—ä»Šå›ã¯ãã®ã¾ã¾è©¦ã—ã¾ã™ï¼‰", 2200);
          }
          const src = await readFileAsDataURL(file);
          post.media = { type: file.type, src, persisted: true, name: file.name, size };
        } else if(isVid){
          if(size <= VIDEO_PERSIST_LIMIT){
            const src = await readFileAsDataURL(file);
            post.media = { type: file.type, src, persisted: true, name: file.name, size };
          } else {
            // session-only via object URL (not storable safely)
            const url = URL.createObjectURL(file);
            post.media = { type: file.type, src: url, persisted: false, name: file.name, size };
            $("mediaNote").innerHTML = `<span class="danger">âš ï¸ å‹•ç”»ãŒå¤§ãã„ã®ã§ã€Œãã®å ´ã ã‘ã€æ‰±ã„ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ã§æ¶ˆãˆã‚‹å¯èƒ½æ€§ï¼‰ã€‚</span>`;
          }
        } else {
          toast("å¯¾å¿œã—ã¦ãªã„å½¢å¼ã§ã™ï¼ˆç”»åƒ/å‹•ç”»ã®ã¿ï¼‰");
        }
      } catch(e){
        toast("ãƒ¡ãƒ‡ã‚£ã‚¢èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
    }

    // store
    const posts = getPosts();
    posts.push(post);

    // if over 10, drop oldest
    posts.sort((a,b)=> (a.time||"").localeCompare(b.time||""));
    while(posts.length > MAX_POSTS){
      const gone = posts.shift();
      // revoke object URL if needed
      if(gone?.media && gone.media.type?.startsWith("video/") && gone.media.persisted === false){
        try{ URL.revokeObjectURL(gone.media.src); }catch(e){}
      }
    }

    // attempt save; if localStorage quota blows, fallback: drop media and save again
    try{
      setPosts(posts);
    } catch(e){
      // degrade: strip persisted media dataURLs
      const degraded = posts.map(p => {
        if(p.media && p.media.persisted === true){
          return { ...p, media: null, _note: "media_stripped_quota" };
        }
        return p;
      });
      try{
        setPosts(degraded);
        toast("å®¹é‡ã®éƒ½åˆã§ãƒ¡ãƒ‡ã‚£ã‚¢ã‚’å¤–ã—ã¦ä¿å­˜ã—ã¾ã—ãŸï¼ˆæœ¬æ–‡ã¯æ®‹ã£ã¦ã„ã¾ã™ï¼‰", 2400);
      } catch(e2){
        toast("ä¿å­˜å®¹é‡ãŒè¶³ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ä¸è¦ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆã—ã¦ãã ã•ã„ã€‚", 2400);
        return;
      }
    }

    // reset input
    $("postText").value = "";
    $("postMedia").value = "";
    saveDraft();
    renderProfile();
    renderFeed();
    toast("æŠ•ç¨¿ã—ã¾ã—ãŸ ğŸœ„");
  });

  // ---------- export / import / wipe ----------
  $("exportBtn").addEventListener("click", () => {
    const payload = {
      version: 1,
      exportedAt: nowISO(),
      profile: getProfile(),
      posts: getPosts()
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "mysticSNS_backup.json";
    a.click();
    setTimeout(() => URL.revokeObjectURL(a.href), 2000);
    toast("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’æ›¸ãå‡ºã—ã¾ã—ãŸ âŸ¡");
  });

  $("importBtn").addEventListener("click", () => $("importFile").click());
  $("importFile").addEventListener("change", async (ev) => {
    const f = ev.target.files?.[0];
    if(!f) return;
    try{
      const txt = await f.text();
      const data = JSON.parse(txt);
      if(!data || typeof data !== "object") throw new Error("bad");

      if(data.profile) setProfile({ ...defaultProfile, ...data.profile });
      if(Array.isArray(data.posts)){
        // keep only latest 10
        const posts = data.posts.slice().sort((a,b)=> (a.time||"").localeCompare(b.time||"")).slice(-MAX_POSTS);
        setPosts(posts);
      }
      renderProfile();
      renderFeed();
      toast("èª­ã¿è¾¼ã¿ã¾ã—ãŸ âŸ¡");
    } catch(e){
      toast("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
    } finally {
      ev.target.value = "";
    }
  });

  $("wipeBtn").addEventListener("click", () => {
    const ok = confirm("æœ¬å½“ã«å…¨æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿï¼ˆå®Œå…¨ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆã¾ã™ï¼‰");
    if(!ok) return;
    localStorage.removeItem(K.profile);
    localStorage.removeItem(K.posts);
    localStorage.removeItem(K.draft);
    renderProfile();
    renderFeed();
    loadDraft();
    toast("å…¨æ¶ˆå»ã—ã¾ã—ãŸ");
  });

  // open TL
  $("openTL").addEventListener("click", () => {
    // same folder ã« index_tl.html ãŒã‚ã‚‹æƒ³å®š
    const url = location.href.replace(/index\.html?$/i, "index_tl.html");
    window.open(url, "mysticTL", "width=520,height=820");
  });

  // ---------- init ----------
  renderProfile();
  renderFeed();
  loadDraft();
  startAutoBump();
})();
</script>
</body>
</html>
