<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>Canvas Editor FINAL COMPLETE</title>

<style>
body{
  margin:0;
  display:flex;
  height:100vh;
  background:#222;
  color:#fff;
  font-family:sans-serif;
}
#canvasWrap{
  flex:1;
  display:flex;
  justify-content:center;
  align-items:center;
  background:#000;
}
canvas{
  background:#555;
  touch-action:none;
}
#panel{
  width:440px;
  padding:10px;
  background:#333;
  overflow:auto;
}
.layer-item{
  background:#444;
  padding:4px;
  margin-bottom:4px;
  font-size:11px;
  cursor:pointer;
}
.layer-item.active{ background:#666; }
label{ font-size:12px; display:block; margin-top:6px; }
input,button{ width:100%; }
.inline{
  display:flex;
  gap:6px;
}
.inline label{
  flex:1;
  font-size:11px;
}
#logBox{
  background:#111;
  font-size:11px;
  padding:6px;
  white-space:pre-wrap;
  max-height:220px;
  overflow:auto;
}
</style>
</head>

<body>

<div id="canvasWrap">
  <canvas id="canvas"></canvas>
</div>

<div id="panel">
  <label>画像追加 <input type="file" id="imgInput"></label>

  <div id="layerList"></div>

  <h3>配置</h3>
  <label>X <input type="number" id="xI"></label>
  <label>Y <input type="number" id="yI"></label>
  <label>Scale <input type="number" step="0.01" id="sI"></label>
  <label>Rotate <input type="number" id="rI"></label>

  <div class="inline">
    <label><input type="checkbox" id="flipXI"> 左右反転</label>
    <label><input type="checkbox" id="flipYI"> 上下反転</label>
  </div>

  <h3>縦浮遊</h3>
  <label>縦幅 <input type="number" id="fyI"></label>
  <label>縦速度 <input type="number" id="syI"></label>

  <h3>横・斜め移動</h3>
  <label>横幅 <input type="number" id="fxI"></label>
  <label>横速度 <input type="number" id="sxI"></label>
  <label>角度（度） <input type="number" id="angI"></label>

  <button id="snapshotBtn">スナップショット保存</button>
  <div id="logBox"></div>
</div>

<script>
/* ===== 基本 ===== */
const BASE_W=1280, BASE_H=720;
const RAD=Math.PI/180;

const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const wrap=document.getElementById("canvasWrap");

/* ===== resize ===== */
function resize(){
  const r=wrap.getBoundingClientRect();
  const sc=Math.min(r.width/BASE_W,r.height/BASE_H);
  canvas.width=BASE_W*sc;
  canvas.height=BASE_H*sc;
  ctx.setTransform(sc,0,0,sc,0,0);
}
window.addEventListener("resize",resize);
resize();

/* ===== 状態 ===== */
let layers=[], current=null;
const imageCount={};

/* ===== UI ===== */
const listEl=document.getElementById("layerList");
const xI=document.getElementById("xI");
const yI=document.getElementById("yI");
const sI=document.getElementById("sI");
const rI=document.getElementById("rI");
const flipXI=document.getElementById("flipXI");
const flipYI=document.getElementById("flipYI");
const fyI=document.getElementById("fyI");
const syI=document.getElementById("syI");
const fxI=document.getElementById("fxI");
const sxI=document.getElementById("sxI");
const angI=document.getElementById("angI");
const logBox=document.getElementById("logBox");

/* ===== 画像追加 ===== */
imgInput.onchange=e=>{
  const f=e.target.files[0];
  if(!f) return;

  const base=f.name;
  imageCount[base]=(imageCount[base]||0)+1;
  const no=imageCount[base];
  const display=no===1?base:`${base}【コピー${no}】`;

  const img=new Image();
  img.onload=()=>{
    const l={
      name:display,
      src:base,
      img,
      x:BASE_W/2,
      y:BASE_H/2,
      scale:1,
      rotate:0,
      flipX:false,
      flipY:false,
      floatY:0,
      speedY:1,
      floatX:0,
      speedX:1,
      angle:0
    };
    layers.unshift(l);
    setCurrent(l);
  };
  img.src=URL.createObjectURL(f);
  imgInput.value="";
};

/* ===== レイヤー ===== */
function renderList(){
  listEl.innerHTML="";
  layers.forEach((l,i)=>{
    const d=document.createElement("div");
    d.className="layer-item"+(l===current?" active":"");
    d.textContent=`${i+1} ${l.name}`;
    d.onclick=()=>setCurrent(l);
    listEl.appendChild(d);
  });
}
function setCurrent(l){
  current=l;
  renderList();
  syncUI();
}
function syncUI(){
  if(!current) return;
  xI.value=current.x; yI.value=current.y;
  sI.value=current.scale; rI.value=current.rotate;
  flipXI.checked=current.flipX;
  flipYI.checked=current.flipY;
  fyI.value=current.floatY; syI.value=current.speedY;
  fxI.value=current.floatX; sxI.value=current.speedX;
  angI.value=current.angle;
}

/* ===== UI → 状態 ===== */
xI.oninput=()=>current&&(current.x=+xI.value);
yI.oninput=()=>current&&(current.y=+yI.value);
sI.oninput=()=>current&&(current.scale=+sI.value);
rI.oninput=()=>current&&(current.rotate=+rI.value);
flipXI.onchange=()=>current&&(current.flipX=flipXI.checked);
flipYI.onchange=()=>current&&(current.flipY=flipYI.checked);
fyI.oninput=()=>current&&(current.floatY=+fyI.value);
syI.oninput=()=>current&&(current.speedY=+syI.value);
fxI.oninput=()=>current&&(current.floatX=+fxI.value);
sxI.oninput=()=>current&&(current.speedX=+sxI.value);
angI.oninput=()=>current&&(current.angle=+angI.value);

/* ===== ドラッグ ===== */
let drag=false,last=null;
canvas.addEventListener("pointerdown",e=>{
  drag=true;
  last={x:e.clientX,y:e.clientY};
});
canvas.addEventListener("pointerup",()=>drag=false);
canvas.addEventListener("pointermove",e=>{
  if(!drag||!current) return;
  const rect=canvas.getBoundingClientRect();
  current.x+=(e.clientX-last.x)*BASE_W/rect.width;
  current.y+=(e.clientY-last.y)*BASE_H/rect.height;
  last={x:e.clientX,y:e.clientY};
  syncUI();
});

/* ===== 描画 ===== */
let start=performance.now();
function draw(){
  const t=(performance.now()-start)/1000;
  ctx.fillStyle="#555";
  ctx.fillRect(0,0,BASE_W,BASE_H);

  layers.slice().reverse().forEach(l=>{
    if(!l.img.complete) return;

    const oy=Math.sin(t*l.speedY)*l.floatY;
    const ox=Math.sin(t*l.speedX)*l.floatX;
    const rad=l.angle*RAD;

    const dx=ox*Math.cos(rad);
    const dy=oy+ox*Math.sin(rad);

    ctx.save();
    ctx.translate(l.x+dx,l.y+dy);
    ctx.rotate(l.rotate*RAD);
    ctx.scale(l.flipX?-l.scale:l.scale,l.flipY?-l.scale:l.scale);
    ctx.drawImage(l.img,-l.img.width/2,-l.img.height/2);
    ctx.restore();
  });
  requestAnimationFrame(draw);
}
draw();

/* ===== ログ ===== */
snapshotBtn.onclick=()=>{
  let txt="SNAPSHOT\n";
  layers.forEach((l,i)=>{
    txt+=`${i+1} ${l.name} (src:${l.src})\n`;
    txt+=` x:${l.x} y:${l.y} s:${l.scale} r:${l.rotate}\n`;
    txt+=` flipX:${l.flipX} flipY:${l.flipY}\n`;
    txt+=` fy:${l.floatY} sy:${l.speedY} fx:${l.floatX} sx:${l.speedX} ang:${l.angle}\n`;
  });
  logBox.prepend(Object.assign(document.createElement("div"),{textContent:txt}));
};
</script>

</body>
</html>
